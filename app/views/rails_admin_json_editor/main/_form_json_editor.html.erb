<%= javascript_include_tag "rails_admin_json_editor/rails_admin_json_editor" %>
<%= stylesheet_link_tag "rails_admin_json_editor/rails_admin_json_editor", media: 'all' %>

<div ref="json-editor"
  class="json-editor"
  data-json-result='<%= raw(field.value.blank? ? '{ "components":[] }' : field.value) %>'
  data-json-component-types='<%= raw field.components.to_json %>'>

  <% field.components.each do |component| %>
    <script type="text/x-template" id="template-component-type-<%= component.type %>">
      <div class="component">
        <legend>
          <%= component.label %>
          <div class="btn-group btn-group-sm pull-right">
            <button v-on="click: moveUp" type="button" class="btn btn-default {{ moveUpEnabled ? '' : 'disabled' }}">
              <i class="icon-circle-arrow-up"></i>
            </button>

            <button v-on="click: moveDown" type="button" class="btn btn-default {{ moveDownEnabled ? '' : 'disabled' }}">
              <i class="icon-circle-arrow-down"></i>
            </button>

            <button v-on="click: expanded = !expanded" type="button" class="btn btn-default">
              <i class="{{ expanded ? 'icon-resize-small' : 'icon-resize-full' }}"></i>
            </button>

            <button v-on="click:remove" type="button" class="btn btn-default">
              <i class="icon-remove"></i>
            </button>
          </div>
        </legend>

        <div v-show="expanded">
          <%= content_tag :p, component.help, class: "help-block" unless component.help.nil? %>

          <% component.fields.each do |f| %>
            <div class="control-group row">
              <label class="col-sm-2 control-label"><%= f.label %></label>

              <div class="controls col-sm-10">
                <% if f.type == :string %>
                  <input v-model="component.props.<%= f.name %>" type="text" class="form-control" />
                <% end %>

                <% if f.type == :text %>
                  <textarea v-model="component.props.<%= f.name %>" class="form-control"></textarea>
                <% end %>

                <% if f.type == :picker %>
                  <select v-on="change: onChangePicker($event, '<%= f.name %>')" class="form-control record-picker">
                    <option value=""></option>
                    <% f.picker_records.each do |record| %>
                      <option
                        v-attr="selected: pickerOptionIsSelected('<%= f.name %>', '<%= f.picker_label %>', '<%= record.send(f.picker_label) %>')"
                        value="<%= record.send(f.picker_label) %>"
                        data-json="<%= record.to_json %>">
                          <%= record.send(f.picker_label) %>
                      </option>
                    <% end %>
                  </select>
                <% end %>

                <% if f.type == :list %>
                  <div v-repeat="nestedComponent: component.props.<%= f.name %>">
                    <div
                      v-component="component-type-{{ nestedComponent.type }}"
                      v-with="component: nestedComponent, parentComponents: component.props.<%= f.name %>, parentIndex: $index">
                    </div>
                  </div>

                  <!-- Add nested component -- one type allowed -->
                  <% if f.allowed_nested_component_types.count == 1 %>
                    <a href="#"
                      class="btn btn-info"
                      v-repeat="componentType: $root.componentTypes"
                      v-show="nestedComponentTypeIsAllowed(componentType.type, <%= f.allowed_nested_component_types.map { |nct| nct.to_s } %>)"
                      v-on="click: addComponent($event, '<%= f.name %>', componentType.type)">
                        Add {{ componentType.label | lowercase }}
                    </a>
                  <% end %>

                  <!-- Add nested component -- multiple types allowed -->
                  <% if f.allowed_nested_component_types.count > 1 %>
                    <div class="dropdown">
                      <a class="dropdown-toggle btn btn-info" data-toggle="dropdown" href="#">Add component <b class="caret"></b></a>
                      <ul class="dropdown-menu">
                        <li v-repeat="componentType: $root.componentTypes">
                          <a href="#"
                            v-if="nestedComponentTypeIsAllowed(componentType.type, <%= f.allowed_nested_component_types.map { |nct| nct.to_s } %>)"
                            v-on="click: addComponent($event, '<%= f.name %>', componentType.type)">
                              {{ componentType.label }}
                          </a>
                        </li>
                      </ul>
                    </div>
                  <% end %>
                <% end %>

                <%= content_tag :p, f.help, class: "help-block" unless f.help.nil? %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </script>
  <% end %>

  <!-- List all components and their fields -->
  <div v-repeat="component: components">
    <div v-component="component-type-{{ component.type }}" v-with="component: component, parentComponents: components, parentIndex: $index"></div>
  </div>

  <!-- Dropdown to add new content -->
  <div class="dropdown pull-left">
    <a class="dropdown-toggle btn btn-info" data-toggle="dropdown" href="#">Add component <b class="caret"></b></a>

    <ul class="dropdown-menu">
      <li v-repeat="componentType: componentTypes">
        <a href="#" v-on="click: addComponent($event, componentType.type)">{{ componentType.label }}</a>
      </li>
    </ul>
  </div>

  <!-- Hidden field to store JSON -->
  <div>
    <% if Rails.env.development? %>
      <button v-on="click: showJson = !showJson" type="button" class="btn btn-default pull-left btn-toggle-json">
        <i class="icon-list-alt"></i>
      </button>
    <% end %>

    <div v-show="showJson">
      <%= form.text_area field.name,
        'v-model' => 'result | json',
        value: field.value,
        ref: 'json-textarea',
        style: 'width:100%; height:400px; margin-top:20px' %>
    </div>
  </div>
</div>
